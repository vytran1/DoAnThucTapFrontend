<!-- sale-pos.component.html -->
<div class="sale-pos-container">
  <!-- Left: Product Table -->
  <div class="product-table">
    <div class="header">
      <h3>Product Table</h3>
      <button mat-flat-button color="primary" (click)="openSearchingModal()">
        + Choose Products
      </button>
    </div>

    <form [formGroup]="orderForm">
      <table mat-table [dataSource]="dataSource" class="full-width">
        <!-- Image -->
        <ng-container matColumnDef="image">
          <th mat-header-cell *matHeaderCellDef>Image</th>
          <td mat-cell *matCellDef="let group; let i = index">
            @if(group.value.image == '' || group.value.image ==
            'product_default.png'){
            <img
              [src]="prefixPath + '/' + 'product_default.png'"
              alt="Product image"
              width="200"
              height="200"
            />
            }@else {

            <img
              [src]="
                prefixPath +
                '/' +
                group.value.productId +
                '/' +
                group.value.image
              "
              alt="Product image"
              width="200"
              height="200"
            />
            }
          </td>
        </ng-container>

        <!-- SKU -->
        <ng-container matColumnDef="sku">
          <th mat-header-cell *matHeaderCellDef>SKU</th>
          <td mat-cell *matCellDef="let group; let i = index">
            {{ group.value.sku }}
          </td>
        </ng-container>

        <!-- Name -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let group; let i = index">
            {{ group.value.name }}
          </td>
        </ng-container>

        <!-- Quantity -->
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Quantity</th>
          <td mat-cell *matCellDef="let group; let i = index">
            <mat-form-field appearance="outline" style="width: 100px">
              <input
                matInput
                type="number"
                min="1"
                [max]="group.value.maxQuantity"
                [formControl]="group.get('quantity')"
              />
              <mat-error *ngIf="group.get('quantity')?.hasError('required')">
                Quantity is required
              </mat-error>
              <mat-error *ngIf="group.get('quantity')?.hasError('min')">
                Quantity must be at least 1
              </mat-error>
              <mat-error *ngIf="group.get('quantity')?.hasError('max')">
                Max allowed: {{ group.value.maxQuantity }}
              </mat-error>
            </mat-form-field>
            / {{ group.value.maxQuantity }}
          </td>
        </ng-container>

        <!-- Price -->
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Price</th>
          <td mat-cell *matCellDef="let group">
            {{ group.value.cost_price | currency : "USD" : "symbol" : "1.0-0" }}
          </td>
        </ng-container>

        <!-- Delete -->
        <ng-container matColumnDef="delete">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let group; let i = index">
            <button mat-icon-button color="warn" (click)="removeItem(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          [formGroup]="row"
        ></tr>
      </table>
    </form>
    <div class="modal-overlay" *ngIf="isOpenSearchingModal">
      <app-search-variant-table
        (close)="closeSearchingModal()"
        (addToCart)="addProductToOrder($event)"
      ></app-search-variant-table>
    </div>
  </div>

  <!-- Right: Order Info -->
  <div class="order-info">
    <h3>Order Info</h3>
    <p><strong>Quantity:</strong> {{ totalQuantity }}</p>
    <p>
      <strong>Tax:</strong>
      {{ totalTax | currency : "USD" : "symbol" : "1.0-0" }}
    </p>
    <p>
      <strong>Total:</strong> {{ totalPrice + totalTax | currency : "USD" }}
    </p>

    <button
      mat-raised-button
      color="accent"
      [disabled]="orderForm.invalid"
      (click)="submitInvoice()"
    >
      Pay
    </button>
    <div *ngIf="orderForm.hasError('noItems')" class="toast-error">
      <mat-error>You must select at least one product</mat-error>
    </div>
  </div>
</div>
