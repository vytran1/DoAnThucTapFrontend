<mat-card class="stockin-container">
  <h2 class="title">New Stock-in</h2>
  <form [formGroup]="orderForm" (ngSubmit)="createStockIn()">
    <mat-form-field appearance="fill" class="supplier-select">
      <mat-label>Supplier</mat-label>
      <mat-select formControlName="supplier">
        <mat-option *ngFor="let supplier of suppliers" [value]="supplier.id">
          {{ supplier.name }} - {{ supplier.supplier_code }}
        </mat-option>
      </mat-select>
      <mat-error
        *ngIf="
          orderForm.get('supplier')?.invalid &&
          orderForm.get('supplier')?.touched
        "
      >
        Please select a supplier.
      </mat-error>
    </mat-form-field>

    <div class="button-row right">
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="openModalAddProduct()"
      >
        Add Product
      </button>
      <button
        mat-raised-button
        type="button"
        style="background-color: #28a745; color: white"
        (click)="openModalUploadFile()"
      >
        Import from Excel
      </button>
    </div>
    <div class="table-scroll-wrapper">
      <table
        mat-table
        [dataSource]="dataSource"
        class="mat-elevation-z2 stock-table"
        formArrayName="stockItems"
      >
        <!-- SKU -->
        <ng-container matColumnDef="sku">
          <th mat-header-cell *matHeaderCellDef>SKU</th>
          <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
            {{ row.get("sku")?.value }}
          </td>
        </ng-container>

        <!-- Name -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
            {{ row.get("name")?.value }}
          </td>
        </ng-container>

        <!-- Quantity -->
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Quantity</th>
          <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
            <input
              matInput
              type="number"
              formControlName="quantity"
              style="width: 80px"
            />
            <mat-error *ngIf="row.get('quantity')?.hasError('required')">
              Quantity is required.
            </mat-error>
            <mat-error *ngIf="row.get('quantity')?.hasError('min')">
              Quantity must be at least 1.
            </mat-error>
          </td>
        </ng-container>

        <!-- Expected Price -->
        <ng-container matColumnDef="expectedPrice">
          <th mat-header-cell *matHeaderCellDef>Expected Price</th>
          <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
            <input
              matInput
              type="number"
              formControlName="expected_price"
              style="width: 100px"
            />
            <mat-error *ngIf="row.get('expected_price')?.hasError('required')">
              Expected price is required.
            </mat-error>
            <mat-error *ngIf="row.get('expected_price')?.hasError('min')">
              Expected price cannot be negative.
            </mat-error>
          </td>
        </ng-container>

        <!-- Action -->
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef>Action</th>
          <td mat-cell *matCellDef="let row; let i = index">
            <button mat-icon-button color="warn" (click)="removeItem(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>

    <p *ngIf="stockItems.length === 0" class="empty-text">
      No stock items added.
    </p>

    <div class="create-stockin-button">
      <button
        mat-raised-button
        color="accent"
        type="submit"
        [disabled]="
          orderForm.invalid || stockItems.length === 0 || isProcessing
        "
      >
        Create Stock-in
      </button>
    </div>
  </form>

  <app-product-table
    *ngIf="isOpenModalAddProduct"
    (close)="closeModalAddProduct()"
    (itemEmitter)="addSelectedProductsFromProductTable($event)"
  ></app-product-table>

  @if(isOpenModalUploadFile){
  <app-upload-file
    (closed)="closeModalUploadFile()"
    [acceptType]="'.xlsx,.xls'"
    (fileUploaded)="importFromExcel($event)"
  ></app-upload-file>
  } @if(isOpenMessageModal){
  <app-message-modal
    [title]="title"
    [message]="message"
    (closed)="closeModalMessageModal()"
  >
  </app-message-modal>
  }
</mat-card>
